<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../stylesheets/common.css" />
<link rel="stylesheet" href="../stylesheets/style.css" />

<title>开发你自己的XMPP IM</title>
</head>
<body>
<div class="screen">
	﻿<div class="header">
	<div class="online_state">
		
	</div>
	<div class="logo">
		<a href="/"><img id="header_logo" src="http://blog.yutouxiuxiu.com//images/logo.png" /></a>
	</div>
	<div class="description">
		芋家修修的技术博客 java,php,android,mysql,oracle,linux,mcu...
	</div>
</div>

	<div class="center">
		<div class="main">
		<div id="" class="post-home">
	<div class="a-post">
		<div class="post-title">
			<h2>
				<a rel="bookmark" href="">
					开发你自己的XMPP IM
				</a>
			</h2>
			<span class="post-time">
				{ post:time }
			</span>
		</div>
		<div class="post-content">
			<ul style="font-family: Arial; font-size: 14px; line-height: 26px;">
	<li>
		<span style="font-size: medium;"><strong>开发你自己的XMPP IM - [J2EE]</strong></span>
	</li>
</ul>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<br />
	<span style="font-size: small;">这几天查国内外的资料，发现国内关于这方面间的软件资料太少了，就想在这里写几篇关于此类IM 软件开发的文章。不过别看东西小，涉及的模块可不少。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">所以我基本上分为三篇文章来介绍此类软件的开发：</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">第一篇是关于XMPP 协议是啥，IM 是啥以及一个比较有名的开源实现，该开源实现包括三个部分（Spark、Smack和Openfire）；</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">第二篇讲如何开发基于Spark 的客户端IM 插件部分；</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">第三篇讲如何开发基于Openfire 服务器端的插件部分。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">好了，进入正题吧。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">什么是XMPP？<br />
	Extensible Messaging and Presence Protocol，简单的来讲，它就是一个发送接收处理消息的协议，但是这个协议发送的消息，既不是二进制的东东也不是字符串，而是XML。正是因为使用了XML作为消息传递的中介，Extensible 才谈的上，不是么？嘿嘿。再详尽的东西，我也就不多介绍了，大家可以去百度百科里查看下。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">什么是IM ？</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Instant Messenger，及时通信软件，就是大家使用的QQ、MSN Messenger和Gtalk等等。其中Gtalk 就是基于XMPP 协议的一个实现，其他的则不是。当前IM 几乎作为每个上网者必然使用的工具，在国外的大型企业中有一些企业级的IM应用，但是其商业价值还没完全发挥出来。设想既然XMPP 协议是一个公开的协议，那么每个企业都可以利用它来开发适合本身企业工作，提高自身生产效率的IM；甚至，你还可以在网络游戏中集成这种通信软件，不但让你可以边游戏边聊天，也可以开发出适合游戏本身的IM 应用，比如说一些游戏关键场景提醒功能，团队语音交流等等都可以基于IM来实现。说了这么多，就是一个意思，其商业价值远远比你想的高！</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Spark Smack 和 Openfire</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">开源界总是有许多有趣的东东，这三个合起来就是一个完整的XMPP IM 实现。包括服务器端&mdash;&mdash;Openfire，客户端&mdash;&mdash;Spark，XMPP 传输协议的实现&mdash;&mdash;Smack（记住，XMPP是一个协议，协议是需要实现的，Smack起到的就是这样的一个作用）。三者都是基于Java 语言的实现，因此对于熟悉Java 的开发者来说不是很难</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<br />
	<span style="font-size: small;">Spark 提供了客户端一个基本的实现，并提出了一个很好的插件架构，这对于开发者来说不能不说是一个福音。我强烈建议基于插件方式来实现你新增加的功能，而不是去改它的源代码，这样有利于你项目架构，把原始项目的影响降到最低，文章以后的部分也是基于这种插件体系进行开发的</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Openfire 是基于XMPP 协议的IM 的服务器端的一个实现，虽然当两个用户连接后，可以通过点对点的方式来发送消息，但是用户还是需要连接到服务器来获取一些连接信息和通信信息的，所以服务器端是必须要实现的。Openfire 也提供了一些基本功能，但真的很基本的！庆幸的是，它也提供插件的扩展，像Spark 一样，我同样强烈建议使用插件扩展的方式来增加新的功能，而不是修改人家的源代码。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Smack 是一个XMPP 协议的Java 实现，提供一套可扩展的API，不过有些时候，你还是不得不使用自己定制发送的XML 文件内容的方式来实现自己的功能</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">下图展示了三者之间的关系：</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	&nbsp;
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;<img alt="" src="http://p.blog.csdn.net/images/p_blog_csdn_net/windone0109/EntryImages/20091015/1.png" style="border: none;" /></span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">从图上可以了解到，client 端和server端都可以通过插件的方式来进行扩展，smack是二者传递数据的媒介。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px;">
	&nbsp;
</p>

<ul style="font-family: Arial; font-size: 14px; line-height: 26px;">
	<li>
		<span style="font-size: medium;"><strong>开发你自己的XMPP IM 续 - Spark 插件开发 - [J2EE]</strong></span>
	</li>
</ul>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<br />
	<span style="font-size: small;">继续3月18日介绍基于XMPP IM开发的那篇Blog，今天主要总结一下如何基于Spark 的插件架构来新增客户端的功能，这里列举出一个获取服务器端群组信息的实际例子，实现后的效果如下图所示：</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;"><span style="font-size: medium;"><strong><img alt="" src="http://p.blog.csdn.net/images/p_blog_csdn_net/windone0109/EntryImages/20091015/2.jpg" style="border: none;" /></strong></span></span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	&nbsp;
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Spark 是一个基于XMPP 协议，用Java 实现的IM 客户端。它提供了一些API，可以采用插件机制进行扩展，上图中，&ldquo;部门&rdquo;部分就是使用插件机制扩展出来的新功能。要想实现你的扩展，首先要了解 Spark API的架构，其中最关键的是要了解它的工厂类，这些工厂类可以获得Spark 提供的诸如XMPPConnection、ChatContainer 等实例，从而你可以实现获取服务器的信息，与另外的Client 通信等功能。最核心的类是SparkManager，这个类是一系列工厂类的工厂类（呵呵，还真拗口）。它的getChatManager()、getSessionManager ()、getMainWindow() 、getConnection() 等方法分别可以获得聊天管理器、会话管理器、主窗口、与服务器的连接等等非常有用的实例。基本上可以说SparkManager 是你与Spark 打交道的衔接口。其实，每一个Manager 都使用了单例模式，你也可以不通过SparkManager 来获取它们，但笔者建议你从单一的入口着手，这样有利于代码的开发和维护。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">接下来描述一下插件的开发流程：<br />
	1、创建插件配置文件 plugin.xml<br />
	2、实现你自己的Plugin 类的实现（如果你需要实现自己规定格式的XML 发送、接收和处理，那么你需要在这里注册你的IQProvider，关于IQProvider 你可以查询Smack API，简单的来讲是处理你自定义的IQ 处理器。）<br />
	3、打包你的插件（Spark 有自己的打包机制，我研究了半天才发现其中的玄机，后面介绍）<br />
	4、部署你的插件（其实3、4两步可以糅合在一起，当然要利用Ant 啦）</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">好滴，下面结合一个实际的例子讲述上面的四个步骤<br />
	1、plugin.xml</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;plugin&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;name&gt;Enterprise IM Client&lt;/name&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;version&gt;1.0&lt;/version&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;author&gt;Phoenix&lt;/author&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;homePage&gt;http://phoenixtoday.blogbus.com&lt;/homePage&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;email&gt;phoenixtoday@gmail.com&lt;/email&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;description&gt;Enterprise Client Plug-in&lt;/description&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;!-- 关键是这里，这里要定义你的Plugin 类 --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;class&gt;com.im.plugin.IMPlugin&lt;/class&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;!-- 这里定义你使用的Spark 最低版本 --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;minSparkVersion&gt;2.5.0&lt;/minSparkVersion&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;os&gt;Windows&lt;/os&gt;<br />
	&lt;/plugin&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">这是一个 plugin.xml 文件的内容，插件体系会自动调用你在此文件中定义的Plugin 类，从而完成你自己扩展的功能。最关键的部分我用红色标识出来了，要声明你的插件扩展类，采用完整的命名空间方式（包括包名），其余的部分结合我的注释，大家应该都能理解，就不做详细的描述了。要注意的是plugin.xml 文件要放在项目的根目录下，这是严格规定好的。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">2、Plugin 类的实现<br />
	你的类首先要实现Spark 提供的Plugin 接口，然后实现它的一些方法。其中最主要的是实现initialize() 发放，在这里注册你的的IQProvider</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">ProviderManager providerManager = ProviderManager.getInstance();<br />
	providerManager.addIQProvider(&quot;groups&quot;, &quot;com:im:group&quot;, //1<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new GroupTreeIQProvider());<br />
	System.out.println(&quot;注册GroupTree IQ 提供者&quot;);<br />
	requestGroupTree();</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">上述的代码，就在该类就是我实现的IMPlugin.initialize() 方法中的一小段，大概的含义是，先获取ProviderManager（这个貌似不能从SparkManager 直接获取），然后注册一个GroupTreeIQProvider（自己创建的）这是一个IQProvider 的具体实现，它用于解析像下面这样的一个XML 文件：</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
	&lt;iq type=&#39;result&#39;&nbsp;</span><a href="mailto:to='domain@server.com'" style="color: rgb(51, 102, 153); text-decoration: none;"><span style="font-size: small;">to=&#39;domain@server.com&#39;</span></a><span style="font-size: small;">&nbsp;</span><a href="mailto:from='phoenixtoday@gmail.com'" style="color: rgb(51, 102, 153); text-decoration: none;"><span style="font-size: small;">from=&#39;phoenixtoday@gmail.com&#39;</span></a><span style="font-size: small;">&nbsp;id=&#39;request_1&#39;&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;groups xmlns=&#39;com:im:group&#39;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;group&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;groupId&gt;1&lt;/groupId&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;name&gt;西安交通大学&lt;/name&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;upGroup&gt;ROOT&lt;/upGroup&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;isLeaf&gt;0&lt;/isLeaf&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;description&gt;xjtu&lt;/description&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;user&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;userGroupId&gt;1&lt;/userGroupId&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;userName&gt;phoenix_test&lt;/userName&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;role&gt;normal&lt;/role&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/user&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/group&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;group&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;groupId&gt;2&lt;/groupId&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;name&gt;电信学院&lt;/name&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;upGroup&gt;1&lt;/upGroup&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;isLeaf&gt;1&lt;/isLeaf&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;description&gt;xjtu info&lt;/description&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/group&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/groups&gt;<br />
	&lt;/iq&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">可以看到，在注册 IQProvider 的时候（代码中标注的1部分），需要你提供名称和命名空间，我的XML 文件中的iq 下的第一个子节点是&lt;groups&gt; 所以我的名称就写&ldquo;groups&rdquo;，命名空间对应于groups 节点的xmlns(XML Name Space)所以是&ldquo;com:im:group&rdquo;，其实IQProvider 中最关键的方法是parseIQ(XmlPullParser parser) 该方法就是解析XML，完成你的功能，并返回一个相应的IQ 实例（这里可以把IQ 看做一个回馈的Model 类）。说到底实现基于XMPP 协议的IM 就是解析XML 文件，而这正是客户端的IQProvider 和服务器端的IQHandler（下一篇文章会涉及到）所做的事情。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">3、打包你的插件<br />
	现在该有的功能都实现了，那么就是打包了。这最好利用Ant 来完成，因为每次你都要打包，要部署，如果纯手动的话，那也太不敏捷了，大大影响开发效率。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
	&lt;project name=&quot;IM&quot; default=&quot;release&quot; basedir=&quot;.&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;src.dir&quot; value=&quot;src&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;dest.dir&quot; value=&quot;bin&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;lib.dir&quot; value=&quot;lib&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;im.path&quot;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value=&quot;E:/workspace/europa/spark_new/doc/spark/target/build&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;target name=&quot;clean&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!--&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;delete dir=&quot;${dest.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;delete dir=&quot;${lib.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;target name=&quot;init&quot; depends=&quot;clean&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!--&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;mkdir dir=&quot;${dest.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;mkdir dir=&quot;${lib.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;target name=&quot;build&quot; depends=&quot;init&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!--<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;javac srcdir=&quot;${src.dir}&quot; destdir=&quot;${dest.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;!-- 最重要的是这里，打两次包 --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;target name=&quot;jar&quot; depends=&quot;build&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;jar jarfile=&quot;${lib.dir}/eim.jar&quot; basedir=&quot;${dest.dir}&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;jar jarfile=&quot;${im.path}/plugins/eim.jar&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;fileset dir=&quot;.&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;lib/*.jar&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/fileset&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;fileset dir=&quot;.&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;plugin.xml&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/fileset&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/jar&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;target name=&quot;release&quot; depends=&quot;jar&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!--&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;exec executable=&quot;cmd.exe&quot;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; failonerror=&quot;true&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;arg line=&quot;/c e:&quot;/&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;arg line=&quot;/c cd workspace/europa/spark_new/doc/spark/target/build/bin&quot;/&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;arg line=&quot;/c startup.bat&quot;/&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/exec&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;<br />
	&lt;/project&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">这是我的这个项目的 build.xml 文件中的内容。因为Eclipse 其实帮我自动完成了编译的任务，所以我也就省去了这写编译的步骤，最重要的是大家要看到&ldquo;jar&rdquo; 部分，Spark 打包的神秘之处也就在此，打两次包首先把你的项目打包到本项目lib 文件夹下，比如说你的项目目录是MyPlugin 那么，你就将你的类打包到MyPlugin/lib 目录下，然后再次的打包，将所有的lib 文件夹下的内容打包起来，记得这次要包含plugin.xml。也就是说，最后Spark 插件体系会读取你的项目下的lib 文件夹下的内容。这里我也有个疑问，我本来想每次打包后自动执行bat 文件，启动插件，看看效果，为啥死都调用不了呢，那段代码在最后面，注释掉了，谁能帮我解决，我请他吃饭滴！</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">4、最后就是发布了</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">其实我的发布很简单，就是将这个打包好的jar 文件拷到Spark 本身的plugins 目录下，每次启动Spark 的时候，它会自动调用自定义的插件的。我这里用Ant 第二次jar 的时候，就自动拷贝过去了，这里用的是绝对路径，所以你不能直接拷贝就用滴呦（是不是很丑陋呀，这段Ant 代码）。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">基本上客户端的实现原理就是这样的，只是有些地方需要特别注意，还有就是应该利用像Ant 这样的工具大大简化开发步骤，加快开发效率。还有就是，我建议你在开发自己的插件的时候，多利用MVC 模式，尤其是在IQProvider 解析后，生成的部分可以实例化Model，然后你可以编写自己的Manager 进行这些Model 的处理。多写Log，当然Log4j 貌似不太起作用，那就System.out.println() 吧，哈哈！今天就写到这里啦，偶有点累啦。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px;">
	&nbsp;
</p>

<ul style="font-family: Arial; font-size: 14px; line-height: 26px;">
	<li>
		<span style="font-size: medium;"><strong>开发你自己的XMPP IM 续 - Openfire 插件开发 - [J2EE]</strong></span>
	</li>
</ul>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<br />
	<span style="font-size: small;">继续上一篇的内容，本篇文章介绍开发Openfire 的插件</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">这篇文章拖了很久了，呵呵，真是千呼万唤始出来呀。Openfire 服务器端是支持插件开发的，开发过程可能会涉及到数据库的操作，本篇文章专注于Openfire 插件的部分，对服务器端涉及到数据库的开发只做简单介绍。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Openfire 是一个用Java 实现的XMPP 服务器，客户端可以通过IQ 的方式与其进行通信（其实就是XML），客户端和服务器之间的通信是依靠底层Smack 库提供的各种功能来完成的。其实利用插件方式来扩展Openfire 服务器端主要有两种扩展方式，一种是对服务器控制台页面进行扩展（不是本文的主要内容），其实就是遵循Openfire 页面的布局方式，进行相应的页面扩展和功能扩展；另一种是对通信功能进行扩展。本文主要针对后者进行具体的描述</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">本篇文章的结构如下：</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">1、创建plugin.xml（这是整个插件最关键的文档）<br />
	2、创建服务器插件实例（实现Plugin 接口的一个类还有一批IQHandler）<br />
	3、打包插件（Openfire 插件也有自己的打包方式）和部署插件</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">好滴，实刀实枪的来动手做吧</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">1、创建plugin.xml</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">初次开发Openfire 和Spark 插件的时候，很容易把二者搞混，千万记得，这里是Openfire 的plugin.xml 不是第二篇文章说的那个啦！</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
	&lt;plugin&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;!-- Main plugin class&nbsp; 这里是最重要滴--&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;class&gt;com.im.server.plugin.GroupTreePlugin&lt;/class&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;!-- Plugin meta-data --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;name&gt;GroupTreePlugin&lt;/name&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;description&gt;This is the group plugin.&lt;/description&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;author&gt;Phoenix&lt;/author&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;version&gt;1.0&lt;/version&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;date&gt;14/03/2008&lt;/date&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;url&gt;http://localhost:9001/openfire/plugins.jsp&lt;/url&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;minServerVersion&gt;3.4.1&lt;/minServerVersion&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;licenseType&gt;gpl&lt;/licenseType&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;!-- Admin console entries --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;adminconsole&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- More on this below --&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/adminconsole&gt;<br />
	&lt;/plugin&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">最重要的那一行我已经标记出来啦，就是你这个插件的初始化和垃圾清理类，例子中是在com.im.server.plugin 包中的GroupTreePlugin 类，下文会对这个类进行详细描述。其余的都是描述信息，只要你提供了正确的描述信息，一般都不会出错。建议初次开发者，在写完plugin.xml 文件后，写一个简单的Plugin 实例，并打印出一些信息，如果重新启动Openfire 信息成功显示，恭喜你，你已经迈出一大步了！</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">2、实现Plugin 类和IQHandler</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">Plugin 类主要起到的作用是初始化和释放资源，在初始化的过程中，最重要的的注册一批IQHandler，IQHander 的作用有点类似于Spark 中的IQProvider，其实就是解析XML 文件之后，生成一些有用的实例，以供处理。下面分别给出一个Plugin 类的实例和IQProvider 的实例</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">GroupTreePlugin 类</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">/**<br />
	&nbsp;* 服务器端插件类<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* @author Phoenix<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* Mar 14, 2008 11:03:11 AM<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* version 0.1<br />
	&nbsp;*/<br />
	public class GroupTreePlugin implements Plugin<br />
	{<br />
	&nbsp;&nbsp;&nbsp; private XMPPServer server;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; /*<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * @see org.jivesoftware.openfire.container.Plugin#destroyPlugin()<br />
	&nbsp;&nbsp;&nbsp;&nbsp; */<br />
	&nbsp;&nbsp;&nbsp; public void destroyPlugin()<br />
	&nbsp;&nbsp;&nbsp; {</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; }</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; /*<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * @see org.jivesoftware.openfire.container.Plugin#initializePlugin(org.jivesoftware.openfire.container.PluginManager,<br />
	&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.io.File)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; */<br />
	&nbsp;&nbsp;&nbsp; public void initializePlugin(PluginManager manager, File pluginDirectory)<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PluginLog.trace(&quot;注册群组树IQ处理器&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server = XMPPServer.getInstance();<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new GroupTreeIQHander()); //1<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new UserInfoIQHandler());<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new DelUserIQHandler());<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new CreateUserIQHandler());<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new AddGroupUserIQHandler());<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.getIQRouter().addHandler(new SetRoleIQHandler());</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; }</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">}</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">上例所示，在初始化中先找到IQRouter，然后通过IQRouter 注册一批IQHandler，这些IQHander 会自动监听相应命名空间的IQ，然后进行处理；由于这个Plugin 不需要做资源释放的工作，所以在destroyPlugin() 方法中没有任何内容。具体的IQHander 类如下</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">GroupTreeIQHander</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">/**<br />
	&nbsp;* 处理客户端发来的IQ，并回送结果IQ<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* @author Phoenix<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* Mar 14, 2008 4:55:33 PM<br />
	&nbsp;*&nbsp;<br />
	&nbsp;* version 0.1<br />
	&nbsp;*/<br />
	public class GroupTreeIQHander extends IQHandler<br />
	{</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; private static final String MODULE_NAME = &quot;group tree handler&quot;;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; private static final String NAME_SPACE = &quot;com:im:group&quot;;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; private IQHandlerInfo info;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; public GroupTreeIQHander()<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; super(MODULE_NAME);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; info = new IQHandlerInfo(&quot;gruops&quot;, NAME_SPACE);<br />
	&nbsp;&nbsp;&nbsp; }</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; /*<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * @see org.jivesoftware.openfire.handler.IQHandler#getInfo()<br />
	&nbsp;&nbsp;&nbsp;&nbsp; */<br />
	&nbsp;&nbsp;&nbsp; @Override<br />
	&nbsp;&nbsp;&nbsp; public IQHandlerInfo getInfo()<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return info;<br />
	&nbsp;&nbsp;&nbsp; }</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; /*<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * (non-Javadoc)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; * @see org.jivesoftware.openfire.handler.IQHandler#handleIQ(org.xmpp.packet.IQ)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; */<br />
	&nbsp;&nbsp;&nbsp; @Override<br />
	&nbsp;&nbsp;&nbsp; public IQ handleIQ(IQ packet) throws UnauthorizedException<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IQ reply = IQ.createResultIQ(packet);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Element groups = packet.getChildElement();//1<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!IQ.Type.get.equals(packet.getType()))<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;非法的请求类型&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reply.setChildElement(groups.createCopy());<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reply.setError(PacketError.Condition.bad_request);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return reply;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String userName = StringUtils.substringBefore(packet.getFrom().toString(),&quot;@&quot;);</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GroupManager.getInstance().initElement(groups,userName);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reply.setChildElement(groups.createCopy());//2</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(&quot;返回的最终XML&quot; + reply.toXML());</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return reply;<br />
	&nbsp;&nbsp;&nbsp; }</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">}</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">可以看到主要有两个方法，一个是getInfo() 这个方法的目的是提供要解析的命名空间，在本例中，这个IQHandler 对每个命名空间为&quot;com:im:group&quot; 的实例进行处理；还有一个最重要的方法：handleIQ() 该方法对包含指定命名空间的XML 进行解析，然后返回一个解析好的IQ。其实我认为，这个IQHandler 和IQ 的关系就是Controller 和Model 的关系（如果你了解MVC 的话，那么你一定知道我再说什么），只不过这里并没有指定什么View，你完全可以把IQ 当成Model 类进行理解。在这里，我用了GroupManager 进行了XML 的处理，因为我返回的IQ 内容中要从数据库读取所有群组信息，所以转交给GroupManager 进行处理，你完全可以在这个方法中进行具体的XML 处理，在这里，解析和创建新的XML 主要用到的是JDOM（如果你对Java 解析XML 有所了解，那真的太好了！）。程序//1 处主要是获取创建返回的IQ，并获取原来IQ 的子元素（用于创建我们返回的IQ）；程序//2 处很关键，如果你不调用createCopy 方法，程序会出错（程序会死锁还是什么，忘记咧，不好以西）。</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">这就是程序的主体部分，我在这里有一个建议，能不用Openfire 原始的程序函数，就不要用它们。我的提取数据库方式都是自己写的Bean，这样有利于你自己对程序的掌控，其实更有利于快速开发（这世道不是啥都讲究敏捷么，哇哈哈）</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">3、打包插件</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">打包依然遵循二次打包的原则（如果你不了解啥叫要二次打包，请看上一篇）<br />
	这是我的ant 文件，由于Eclipse 帮我做了build 等很多工作，实际我的ant 工作就是在打包，并放入插件目录下的plugin 文件夹下</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br />
	&lt;project name=&quot;IM&quot; default=&quot;release&quot; basedir=&quot;.&quot;&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;property name=&quot;openfire.path&quot;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value=&quot;E:/workspace/europa/openfire_src/target/openfire&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;classes.dir&quot; value=&quot;classes&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;property name=&quot;lib.dir&quot; value=&quot;lib&quot; /&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;target name=&quot;jar&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;jar jarfile=&quot;${lib.dir}/grouptreeplugin.jar&quot; basedir=&quot;${classes.dir}&quot; &gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;fileset dir=&quot;.&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;*.jar&quot;/&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/fileset&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/jar&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;jar jarfile=&quot;${openfire.path}/plugins/groupTreePlugin.jar&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;fileset dir=&quot;.&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;lib/*.jar&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;plugin.xml&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;logo_small.gif&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;logo_large.gif&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;readme.html&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;changelog.html&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;include name=&quot;build.xml&quot; /&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/fileset&gt;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/jar&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;/target&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&nbsp;&nbsp;&nbsp; &lt;target name=&quot;release&quot; depends=&quot;jar&quot;&gt;<br />
	&nbsp;&nbsp;&nbsp; &lt;/target&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">&lt;/project&gt;</span>
</p>

<p style="font-family: Arial; font-size: 14px; line-height: 26px; padding-left: 30px;">
	<span style="font-size: small;">好了，至此XMPP+Spark+Openfire 的插件开发三部曲彻底结束了，希望你们对这个开发流程有了系统的了解。</span>
</p>

		</div>
	</div>
</div>

		</div>
		<div class="sidebar">
		<div id="csidebar">
	<ul>
		<li class="widget widget_recent_entries">
			<h3>分类目录</h3>
			<ul>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_1.html" style="margin-left: 0px;">未分类</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_2.html" style="margin-left: 0px;">HTML</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_3.html" style="margin-left: 10px;">JavaScript</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_17.html" style="margin-left: 10px;">css</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_4.html" style="margin-left: 0px;">Java</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_13.html" style="margin-left: 10px;">集合</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_51.html" style="margin-left: 10px;">多线程</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_54.html" style="margin-left: 10px;">面向对象</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_5.html" style="margin-left: 0px;">JavaWeb</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_6.html" style="margin-left: 10px;">XML</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_20.html" style="margin-left: 10px;">JSP</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_23.html" style="margin-left: 10px;">Servlet</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_49.html" style="margin-left: 10px;">XMPP</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_7.html" style="margin-left: 0px;">分类总结</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_8.html" style="margin-left: 0px;">千奇百怪问题库</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_9.html" style="margin-left: 0px;">小案例</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_18.html" style="margin-left: 10px;">HTML小案例</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_24.html" style="margin-left: 10px;">Servlet小案例</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_10.html" style="margin-left: 0px;">数据库</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_19.html" style="margin-left: 10px;">JDBC</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_28.html" style="margin-left: 20px;">测试</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_21.html" style="margin-left: 10px;">MySQL</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_22.html" style="margin-left: 10px;">Oracle</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_25.html" style="margin-left: 10px;">SQL</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_11.html" style="margin-left: 0px;">框架</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_26.html" style="margin-left: 10px;">Struts2</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_29.html" style="margin-left: 10px;">Hibernate</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_30.html" style="margin-left: 10px;">Spring</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_31.html" style="margin-left: 10px;">jBPM</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_34.html" style="margin-left: 10px;">Zend framework</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_35.html" style="margin-left: 10px;">Extjs</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_39.html" style="margin-left: 10px;">ThinkPHP</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_53.html" style="margin-left: 10px;">jquery</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_55.html" style="margin-left: 10px;">smarty</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_58.html" style="margin-left: 10px;">MyBatis</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_12.html" style="margin-left: 0px;">软件使用</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_27.html" style="margin-left: 10px;">WordPress</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_14.html" style="margin-left: 0px;">面试</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_15.html" style="margin-left: 0px;">项目开发经验</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_16.html" style="margin-left: 0px;">项目进度</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_32.html" style="margin-left: 0px;">缓存技术</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_33.html" style="margin-left: 10px;">Memcached</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_36.html" style="margin-left: 0px;">项目管理工具</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_37.html" style="margin-left: 0px;">Linux</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_52.html" style="margin-left: 10px;">vim</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_38.html" style="margin-left: 0px;">PHP</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_40.html" style="margin-left: 0px;">喜欢的歌</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_41.html" style="margin-left: 0px;">美工</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_42.html" style="margin-left: 10px;">AI</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_43.html" style="margin-left: 10px;">PS</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_44.html" style="margin-left: 0px;">项目管理</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_45.html" style="margin-left: 0px;">服务器管理</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_46.html" style="margin-left: 10px;">Apache</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_47.html" style="margin-left: 10px;">mysql</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_48.html" style="margin-left: 0px;">敏捷开发</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_50.html" style="margin-left: 0px;">PCB</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_56.html" style="margin-left: 0px;">优化</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_57.html" style="margin-left: 10px;">前端优化</a></li>
				
					<li><a href="http://blog.yutouxiuxiu.com/terms/term_59.html" style="margin-left: 0px;">中间件</a></li>
				
			</ul>
		</li>
	</ul>
</div>

		</div>
	</div>
	<div class="footer">
	<div class="copyright">© 2013 芋头修修家 版权所有</div>
</div>

</div>
</body>
</html>
